"use strict";(self.webpackChunkzell_chaos=self.webpackChunkzell_chaos||[]).push([[1836],{33026:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var a=t(74848),s=t(28453);const i={layout:"posts",title:"SST Partitioning toggle",date:new Date("2023-05-15T00:00:00.000Z"),categories:["chaos_experiment","configuration"],tags:["availability","data"],authors:"zell"},r="Chaos Day Summary",o={permalink:"/zeebe-chaos/2023/05/15/SST-Partitioning-toggle",editUrl:"https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-days/blog/2023-05-15-SST-Partitioning-toggle/index.md",source:"@site/blog/2023-05-15-SST-Partitioning-toggle/index.md",title:"SST Partitioning toggle",description:"On this chaos day I wanted to experiment with a new experimental feature we have released recently. The enablement of the partitioning of the SST files in RocksDB. This is an experimental feature from RocksDb, which we made available now for our users as well, since we have seen great benefits in performance, especially with larger runtime data.",date:"2023-05-15T00:00:00.000Z",tags:[{inline:!0,label:"availability",permalink:"/zeebe-chaos/tags/availability"},{inline:!0,label:"data",permalink:"/zeebe-chaos/tags/data"}],readingTime:6.695,hasTruncateMarker:!0,authors:[{name:"Christopher Kujawa",title:"Chaos Engineer @ Zeebe",url:"https://github.com/zelldon",page:{permalink:"/zeebe-chaos/authors/zell"},imageURL:"https://github.com/zelldon.png",key:"zell"}],frontMatter:{layout:"posts",title:"SST Partitioning toggle",date:"2023-05-15T00:00:00.000Z",categories:["chaos_experiment","configuration"],tags:["availability","data"],authors:"zell"},unlisted:!1,prevItem:{title:"Continuing SST Partitioning toggle",permalink:"/zeebe-chaos/2023/05/19/Continuing-SST-Partitioning-toggle"},nextItem:{title:"Gateway Termination",permalink:"/zeebe-chaos/2023/04/06/gateway-termination"}},l={authorsImageUrls:[void 0]},c=[{value:"Chaos Experiment",id:"chaos-experiment",level:2},{value:"Expected",id:"expected",level:3},{value:"Actual",id:"actual",level:3},{value:"First Part: Verify Steady state",id:"first-part-verify-steady-state",level:4},{value:"First Part: Chaos Action",id:"first-part-chaos-action",level:4},{value:"Second Part:",id:"second-part",level:4},{value:"Further investigation",id:"further-investigation",level:4},{value:"Conclusion",id:"conclusion",level:3}];function h(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.p,{children:["On this chaos day I wanted to experiment with a new experimental feature we have released recently. The ",(0,a.jsx)(n.a,{href:"https://github.com/camunda/camunda/pull/12483",children:"enablement of the partitioning of the SST files in RocksDB"}),". This is an experimental feature from RocksDb, which we made available now for our users as well, since we have seen great benefits in performance, especially with larger runtime data."]}),"\n",(0,a.jsx)(n.p,{children:"I wanted to experiment a bit with the SST partitioning and find out whether it would be possible to enable and disable the flag/configuration without issues."}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"TL;DR;"})," The first experiment was successful, it looks like we can enable and disable the partitioning without impacting the execution of one existing PI. We need to experiment a bit more with larger data sets to force RocksDB compaction, to be fully sure."]}),"\n",(0,a.jsx)(n.h2,{id:"chaos-experiment",children:"Chaos Experiment"}),"\n",(0,a.jsxs)(n.p,{children:["For our chaos experiment we set up again our ",(0,a.jsx)(n.a,{href:"https://github.com/camunda/camunda/tree/main/benchmarks/setup",children:"normal benchmark cluster"}),", this time without any clients (no workers/starters)."]}),"\n",(0,a.jsx)(n.p,{children:"Setting all client replicas to zero:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-diff",children:"$ diff default/values.yaml zell-chaos/values.yaml \n40c40\n<   replicas: 3\n---\n>   replicas: 0\n47c47\n<   replicas: 1\n---\n>   replicas: 0\n"})}),"\n",(0,a.jsx)(n.p,{children:"The experiment we want to do on this chaos day will look like the following:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"First part:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Verify steady state:","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"verify the readiness of the cluster"}),"\n",(0,a.jsxs)(n.li,{children:["deploy a process model (which contains a ",(0,a.jsx)(n.a,{href:"https://github.com/zeebe-io/zeebe-chaos/blob/main/go-chaos/internal/bpmn/one_task.bpmn",children:"simple model"}),")"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["Chaos Action:","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"start a process instance (PI), with a service task"}),"\n",(0,a.jsx)(n.li,{children:"enable the SST partitioning"}),"\n",(0,a.jsx)(n.li,{children:"restart the cluster"}),"\n",(0,a.jsx)(n.li,{children:"verify the readiness"}),"\n",(0,a.jsx)(n.li,{children:"verify that job is activatable"}),"\n",(0,a.jsx)(n.li,{children:"complete the job (in consequence the PI)"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Second part:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Chaos Action:","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"start a process instance (PI), with a service task"}),"\n",(0,a.jsx)(n.li,{children:"disable the SST partitioning"}),"\n",(0,a.jsx)(n.li,{children:"restart the cluster"}),"\n",(0,a.jsx)(n.li,{children:"verify the readiness"}),"\n",(0,a.jsx)(n.li,{children:"verify that job is activatable"}),"\n",(0,a.jsx)(n.li,{children:"complete the job (in consequence the PI)"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"expected",children:"Expected"}),"\n",(0,a.jsx)(n.p,{children:"When operating a cluster, I can enable the SST partitioning without an impact on executing existing process instances. Existing PIs should still be executable and completable."}),"\n",(0,a.jsx)(n.h3,{id:"actual",children:"Actual"}),"\n",(0,a.jsxs)(n.p,{children:["As linked above I used again our ",(0,a.jsx)(n.a,{href:"https://github.com/camunda/camunda/tree/main/benchmarks/setup",children:"benchmark/setup"})," scripts to set up a cluster."]}),"\n",(0,a.jsx)(n.h4,{id:"first-part-verify-steady-state",children:"First Part: Verify Steady state"}),"\n",(0,a.jsxs)(n.p,{children:["To verify the readiness and run all actions I used the ",(0,a.jsx)(n.a,{href:"https://github.com/zeebe-io/zeebe-chaos/tree/zbchaos-v1.0.0",children:"zbchaos"})," tool."]}),"\n",(0,a.jsx)(n.p,{children:"Verifying readiness is fairly easy with zbchaos."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"$ zbchaos verify readiness -v\nConnecting to zell-chaos\nRunning experiment in self-managed environment.\nPod zell-chaos-zeebe-0 is in phase Pending, and not ready. Wait for some seconds.\n[...]\nPod zell-chaos-zeebe-0 is in phase Running, and not ready. Wait for some seconds.\nPod zell-chaos-zeebe-0 is in phase Running, and not ready. Wait for some seconds.\nAll Zeebe nodes are running.\n"})}),"\n",(0,a.jsx)(n.p,{children:"We then deploy the mentioned simple process model:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"$ zbchaos deploy process -v\nConnecting to zell-chaos\nRunning experiment in self-managed environment.\nPort forward to zell-chaos-zeebe-gateway-7bbdf9fd58-dl97j\nSuccessfully created port forwarding tunnel\nDeploy file bpmn/one_task.bpmn (size: 2526 bytes).\nDeployed process model bpmn/one_task.bpmn successful with key 2251799813685249.\nDeployed given process model , under key 2251799813685249!\n"})}),"\n",(0,a.jsx)(n.h4,{id:"first-part-chaos-action",children:"First Part: Chaos Action"}),"\n",(0,a.jsx)(n.p,{children:"As the first step in the chaos action we create a process instance."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"$ zbchaos verify instance-creation -v\nConnecting to zell-chaos\nRunning experiment in self-managed environment.\nPort forward to zell-chaos-zeebe-gateway-7bbdf9fd58-dl97j\nSuccessfully created port forwarding tunnel\nSend create process instance command, with BPMN process ID 'benchmark' and version '-1' (-1 means latest) [variables: '', awaitResult: false]\nCreated process instance with key 2251799813685251 on partition 1, required partition 1.\nThe steady-state was successfully verified!\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Next, we enable the SST partitioning in our broker configuration, we can do this in the ",(0,a.jsx)(n.code,{children:"values.yaml"})," file and run a ",(0,a.jsx)(n.code,{children:"helm update"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:'$ diff ../default/values.yaml values.yaml \n85a86\n>     zeebe.broker.experimental.rocksdb.enableSstPartitioning: "true"\n'})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:'$ make update\nhelm upgrade --namespace zell-chaos zell-chaos zeebe-benchmark/zeebe-benchmark -f values.yaml\nRelease "zell-chaos" has been upgraded. Happy Helming!\nNAME: zell-chaos\nLAST DEPLOYED: Mon May 15 15:54:24 2023\nNAMESPACE: zell-chaos\nSTATUS: deployed\nREVISION: 2\nNOTES:\n# Zeebe Benchmark\n\nInstalled Zeebe cluster with:\n\n * 3 Brokers\n * 2 Gateways\n\nThe benchmark is running with:\n\n * Starter replicas=0\n * Worker replicas=0\n * Publisher replicas=0\n * Timer replicas=0\n'})}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Note"}),"\nChanging the configmap doesn't restart pods! We need to delete all Zeebe pods, to apply the configuration."]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:'$ k delete pod -l app=camunda-platform\npod "zell-chaos-zeebe-0" deleted\npod "zell-chaos-zeebe-1" deleted\npod "zell-chaos-zeebe-2" deleted\npod "zell-chaos-zeebe-gateway-7bbdf9fd58-8j7d6" deleted\npod "zell-chaos-zeebe-gateway-7bbdf9fd58-dl97j" deleted\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Next we can use ",(0,a.jsx)(n.code,{children:"zbchaos verify readiness"})," again to await the readiness of the cluster."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"All Zeebe nodes are running.\n"})}),"\n",(0,a.jsx)(n.p,{children:"Taking a look at the logs of the broker we can also see that the broker configuration was correctly set:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'   \\"disableWal\\" : true,\\n      \\"enableSstPartitioning\\" : true\\n    }\n'})}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Note"}),"\nRight now zbchaos can't complete an job (missing feature). We use zbctl for that, we need to port-forward to the gateway in order to send the commands."]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"$ k port-forward svc/zell-chaos-zeebe-gateway 26500\nForwarding from 127.0.0.1:26500 -> 26500\nForwarding from [::1]:26500 -> 26500\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"Activating the right job."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:'$ zbctl --insecure activate jobs benchmark-task\n{\n  "jobs":  [\n    {\n      "key":  "2251799813685256",\n      "type":  "benchmark-task",\n      "processInstanceKey":  "2251799813685251",\n      "bpmnProcessId":  "benchmark",\n      "processDefinitionVersion":  1,\n      "processDefinitionKey":  "2251799813685249",\n      "elementId":  "task",\n      "elementInstanceKey":  "2251799813685255",\n      "customHeaders":  "{}",\n      "worker":  "zbctl",\n      "retries":  3,\n      "deadline":  "1684173544716",\n      "variables":  "{}"\n    }\n  ]\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"Completing the job and the PI."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"$ zbctl complete job 2251799813685256 --insecure\nCompleted job with key '2251799813685256' and variables '{}'\n"})}),"\n",(0,a.jsx)(n.h4,{id:"second-part",children:"Second Part:"}),"\n",(0,a.jsxs)(n.p,{children:["Create again a process instance ",(0,a.jsx)(n.code,{children:"$ zbchaos verify instance-creation"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"Created process instance with key 2251799813685263 on partition 1, required partition 1.\nThe steady-state was successfully verified!\n"})}),"\n",(0,a.jsx)(n.p,{children:"Disabling the configuration again, and running the update."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:'$ diff default/values.yaml zell-chaos/values.yaml \n85a86\n>     zeebe.broker.experimental.rocksdb.enableSstPartitioning: "false"\n\n\n$ make update \nhelm upgrade --namespace zell-chaos zell-chaos zeebe-benchmark/zeebe-benchmark -f values.yaml\nRelease "zell-chaos" has been upgraded. Happy Helming!\nNAME: zell-chaos\nLAST DEPLOYED: Mon May 15 20:00:53 2023\n...\n\n$ k delete pod -l app=camunda-platform\n$ zbchaos verify readiness\nAll Zeebe nodes are running.\n'})}),"\n",(0,a.jsx)(n.p,{children:"Again the job completion worked without problems (skipping here the port-forward and activate output)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"$ zbctl complete job 2251799813685268 --insecure\nCompleted job with key '2251799813685268' and variables '{}'\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u2705"," The experiment was successful."]}),"\n",(0,a.jsx)(n.h4,{id:"further-investigation",children:"Further investigation"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:t(18805).A+"",width:"1848",height:"701"})}),"\n",(0,a.jsx)(n.p,{children:"When running the experiment I also observed the metrics of the cluster and was not able to see any differences in the snapshot file counts, which we would expect on the SST partitioning (there should be more files)."}),"\n",(0,a.jsxs)(n.p,{children:["Before the experiment:\n",(0,a.jsx)(n.img,{src:t(90846).A+"",width:"932",height:"814"})]}),"\n",(0,a.jsxs)(n.p,{children:["After the experiment, we still see that for each partition we have around ~6 files.\n",(0,a.jsx)(n.img,{src:t(16599).A+"",width:"938",height:"818"})]}),"\n",(0,a.jsx)(n.p,{children:"In order to make sure whether the options have been applied correctly I investigated the RocksDB log files and option files."}),"\n",(0,a.jsx)(n.p,{children:"In the current LOG file, we can see the current options printed, which is indeed the disabled partitioner. Since this is the default as well it is not a proof yet."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"2023/05/15-18:01:46.223234 139711509092096 [/column_family.cc:621] --------------- Options for column family [default]:\n2023/05/15-18:01:46.223237 139711509092096               Options.comparator: leveldb.BytewiseComparator\n2023/05/15-18:01:46.223239 139711509092096           Options.merge_operator: None\n2023/05/15-18:01:46.223241 139711509092096        Options.compaction_filter: None\n2023/05/15-18:01:46.223242 139711509092096        Options.compaction_filter_factory: None\n2023/05/15-18:01:46.223244 139711509092096  Options.sst_partitioner_factory: None\n"})}),"\n",(0,a.jsxs)(n.p,{children:["What we can see in the runtime folder of the partition is that there exist two Options files, an older one ",(0,a.jsx)(n.code,{children:"OPTIONS-000014"}),", and a newer one ",(0,a.jsx)(n.code,{children:"OPTIONS-000023"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"The older one contains the expected configuration for the SST partitioning:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:'$ cat OPTIONS-000014 \n[CFOptions "default"]\n...\n  sst_partitioner_factory={id=SstPartitionerFixedPrefixFactory;length=8;}\n'})}),"\n",(0,a.jsx)(n.p,{children:"The most recent options file has the configuration set to null."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:'\n$ cat OPTIONS-000023\n[CFOptions "default"]\n...\nsst_partitioner_factory=nullptr\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"We can see that the current snapshot only copied the most recent options file:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"$ ll ../snapshots/188-4-230-244\ntotal 56\ndrwxr-xr-x 2 root root 4096 May 15 18:13 ./\ndrwxr-xr-x 3 root root 4096 May 15 18:13 ../\n...\n-rw-r--r-- 2 root root 7015 May 15 18:01 OPTIONS-000023\n-rw-r--r-- 1 root root   92 May 15 18:13 zeebe.metadata\n"})}),"\n",(0,a.jsx)(n.h3,{id:"conclusion",children:"Conclusion"}),"\n",(0,a.jsx)(n.p,{children:"We were able to toggle the SST partitioning flag without problems back and forth. We were able to make still progress on an existing process instance, which we wanted to prove."}),"\n",(0,a.jsx)(n.p,{children:"Nevertheless, we need to prove this once more for multiple process instances (100-1000 PIs), which cause or forces compaction of the SST files. Right now I'm not 100% convinced whether this experiment was enough, but it was a good first step."})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},18805:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/general-after2-e0b4149303fb10808ec4d1e9215ed7af.png"},16599:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/snapshot-after2-ca6970a41ba78ee802c74de8b18c195d.png"},90846:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/snapshot-before-2140893bacefcc15a0d450c89274d8e2.png"},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var a=t(96540);const s={},i=a.createContext(s);function r(e){const n=a.useContext(i);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),a.createElement(i.Provider,{value:n},e.children)}}}]);