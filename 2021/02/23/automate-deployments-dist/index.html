<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Automating Deployment Distribution Chaos Experiment | Zeebe Chaos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zeebe-io.github.io/zeebe-chaos/2021/02/23/automate-deployments-dist"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Automating Deployment Distribution Chaos Experiment | Zeebe Chaos"><meta data-rh="true" name="description" content="This time I wanted to automate a chaos experiment via the ChaosToolkit, which I did on the last chaos day. For a recap check out the last chaos day summary."><meta data-rh="true" property="og:description" content="This time I wanted to automate a chaos experiment via the ChaosToolkit, which I did on the last chaos day. For a recap check out the last chaos day summary."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-02-23T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/zelldon"><meta data-rh="true" property="article:tag" content="tests"><link data-rh="true" rel="icon" href="/zeebe-chaos/img/zeebe-logo.png"><link data-rh="true" rel="canonical" href="https://zeebe-io.github.io/zeebe-chaos/2021/02/23/automate-deployments-dist"><link data-rh="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/2021/02/23/automate-deployments-dist" hreflang="en"><link data-rh="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/2021/02/23/automate-deployments-dist" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/zeebe-chaos/rss.xml" title="Zeebe Chaos RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zeebe-chaos/atom.xml" title="Zeebe Chaos Atom Feed"><link rel="stylesheet" href="/zeebe-chaos/assets/css/styles.ab1e5a6e.css">
<script src="/zeebe-chaos/assets/js/runtime~main.3133efa7.js" defer="defer"></script>
<script src="/zeebe-chaos/assets/js/main.90f8b76c.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zeebe-chaos/"><div class="navbar__logo"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Zeebe Chaos</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zeebe-chaos/">Chaos Summaries</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/zeebe-io/zeebe-chaos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/11/30/Job-push-overloading">Job push overloading</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/11/07/Hot-backups-impact-on-processing">Hot backups impact on processing</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/06/02/Using-Large-Multi-Instance">Using Large Multi-Instance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/05/19/Continuing-SST-Partitioning-toggle">Continuing SST Partitioning toggle</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/05/15/SST-Partitioning-toggle">SST Partitioning toggle</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/04/06/gateway-termination">Gateway Termination</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/02/23/Recursive-call-activity">Recursive call activity</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/08/31/Message-Correlation-after-Network-Partition">Message Correlation after Network Partition</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/08/02/deployment-distribution">Bring Deployment distribution experiment back</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/02/15/Standalone-Gateway-in-CCSaaS">Standalone Gateway in CCSaaS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/02/01/High-Snapshot-Frequency">High Snapshot Frequency</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/01/19/big-variables">Handling of Big Variables</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/11/24/Worker-count-should-not-impact-performance">Worker count should not impact performance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/11/11/Not-produce-duplicate-Keys">Not produce duplicate Keys</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/10/29/Throughput-on-big-state">Throughput on big state</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/10/05/recovery-time">Recovery (Fail Over) time</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/09/23/Old-Clients">Old-Clients</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/07/06/Slow-Network">Slow Network</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/06/08/Full-Disk">Full Disk Recovery</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/05/25/Reset-Clock">Time travel Experiment</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/04/29/Corrupted-Snapshot">Corrupted Snapshot Experiment Investigation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/04/03/bpmn-meets-chaos-engineering">BPMN meets Chaos Engineering</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/03/30/set-file-immutable">Set file immutable</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/03/23/camunda-cloud-network-partition">Camunda Cloud network partition</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/03/09/cont-workflow-instance">Fault-tolerant processing of process instances</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/zeebe-chaos/2021/02/23/automate-deployments-dist">Automating Deployment Distribution Chaos Experiment</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/01/26/deployments">Deployment Distribution</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/01/19/network-partition">Network partitions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/01/07/disconnect-leader-and-follower">Disconnect Leader and one Follower</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/11/24/message-correlation-after-failover">Message Correlation after Failover</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/11/11/job-timeouts">Many Job Timeouts</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/11/03/investigate-failing-tests">Investigate failing Chaos Tests</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/20/non-graceful-shutdown">Non-graceful Shutdown Broker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/27/standalone-gw-memory">Gateway memory consumption</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/13/multiple-leader-changes">Multiple Leader Changes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/06/toxi-proxy">Play around with ToxiProxy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/08/20/experiment-with-camunda-cloud">Experiment with Camunda Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/08/06/low-load">Experiment with Low Load</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/30/experiment-without-exporters">Experiment without Exporters</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/16/big-multi-instance">Big Multi Instance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/09/timer-and-huge-variables">Experiment with Timers and Huge Variables</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/02/extract-k8-resources">Extract K8 resources from namespace</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/25/gateway-network-partition">Gateway Network Partition</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/18/correlate-message-after-failover">Correlate Message after failover</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/11/high-cpu-gateway">High CPU load on Standalone Gateway</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/04/first-chaos-day">First Chaos Day!</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="This time I wanted to automate a chaos experiment via the ChaosToolkit, which I did on the last chaos day. For a recap check out the last chaos day summary."><header><h1 class="title_f1Hy" itemprop="headline">Automating Deployment Distribution Chaos Experiment</h1><div class="container_mt6G margin-vert--md"><time datetime="2021-02-23T00:00:00.000Z" itemprop="datePublished">February 23, 2021</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/zelldon.png" alt="Christopher Zell" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/zelldon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Christopher Zell</span></a></div><small class="avatar__subtitle" itemprop="description">Chaos Engineer @ Zeebe</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>This time I wanted to automate a chaos experiment via the <a href="https://chaostoolkit.org/" target="_blank" rel="noopener noreferrer">ChaosToolkit</a>, which I did on the last chaos day. For a recap check out the <a href="/zeebe-chaos/2021/01/26/deployments">last chaos day summary</a>.</p>
<p><strong>TL;DR;</strong></p>
<p>I was able to automate the deployment distribution chaos experiment successfully and deployed it on testbench for a <code>Production - M</code> cluster plan.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">​</a></h2>
<p>For testing, I have run our normal setup of three nodes, three partitions and replication factor three.
Later I wanted to automate the experiment against the production cluster plans.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">​</a></h3>
<p>We want to verify whether deployments are still distributed after a network partition, for that we will write the following chaos experiment:</p>
<ol>
<li>Verify Steady State: All Pods are ready</li>
<li>Introduce Chaos:<!-- -->
<ol>
<li><em>Action:</em> Disconnect two leaders (Leader of partition one and another leader)</li>
<li><em>Action:</em> Deploy multiple versions of a workflow</li>
<li><em>Action:</em> Connect two leaders again</li>
<li><em>Probe</em>: I can create workflow instance on all partitions with the last workflow version</li>
</ol>
</li>
<li>Verify Steady State: All Pods are ready</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="experiment-definition">Experiment Definition<a href="#experiment-definition" class="hash-link" aria-label="Direct link to Experiment Definition" title="Direct link to Experiment Definition">​</a></h3>
<p>The experiment definition looks like the following:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;version&quot;: &quot;0.1.0&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;title&quot;: &quot;Zeebe deployment distribution&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;description&quot;: &quot;Zeebe deployment distribution should be fault-tolerant. Zeebe should be able to handle network outages and fail-overs and distribute the deployments after partitions are available again.&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;contributions&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;reliability&quot;: &quot;high&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;availability&quot;: &quot;high&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;steady-state-hypothesis&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;title&quot;: &quot;Zeebe is alive&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;probes&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;name&quot;: &quot;All pods should be ready&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;: &quot;probe&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;tolerance&quot;: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;provider&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;type&quot;: &quot;process&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;path&quot;: &quot;verify-readiness.sh&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;timeout&quot;: 900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;method&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;type&quot;: &quot;action&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;name&quot;: &quot;Create network partition between leaders&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;provider&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;: &quot;process&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;path&quot;: &quot;disconnect-leaders.sh&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;type&quot;: &quot;action&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;name&quot;: &quot;Deploy different deployment versions.&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;provider&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;: &quot;process&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;path&quot;: &quot;deploy-different-versions.sh&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;arguments&quot;: [&quot;Follower&quot;, &quot;3&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;type&quot;: &quot;action&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;name&quot;: &quot;Delete network partition&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;provider&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;: &quot;process&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;path&quot;: &quot;connect-leaders.sh&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;type&quot;: &quot;probe&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;name&quot;: &quot;Create workflow instance of latest version on partition one&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;tolerance&quot;: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;provider&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;: &quot;process&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;path&quot;: &quot;start-instance-on-partition-with-version.sh&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;arguments&quot;: [&quot;1&quot;, &quot;10&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;timeout&quot;: 900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;type&quot;: &quot;probe&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;name&quot;: &quot;Create workflow instance of latest version on partition two&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;tolerance&quot;: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;provider&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;: &quot;process&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;path&quot;: &quot;start-instance-on-partition-with-version.sh&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;arguments&quot;: [&quot;2&quot;, &quot;10&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;timeout&quot;: 900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;type&quot;: &quot;probe&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;name&quot;: &quot;Create workflow instance of latest version on partition three&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;tolerance&quot;: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;provider&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;: &quot;process&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;path&quot;: &quot;start-instance-on-partition-with-version.sh&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;arguments&quot;: [&quot;3&quot;, &quot;10&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;timeout&quot;: 900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;rollbacks&quot;: []</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-network-partition-between-leaders">Create network partition between leaders<a href="#create-network-partition-between-leaders" class="hash-link" aria-label="Direct link to Create network partition between leaders" title="Direct link to Create network partition between leaders">​</a></h4>
<p>We reuse a script which we introduce in earlier chaos days. It needed to be improved a bit, since we haven&#x27;t handled clusters where one node leads multiple partitions.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -exuo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source utils.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partition=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace=$(getNamespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gateway=$(getGateway)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># determine leader for partition one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index=$(getIndexOfPodForPartitionInState &quot;$partition&quot; &quot;LEADER&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leader=$(getBroker &quot;$index&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leaderIp=$(kubectl get pod &quot;$leader&quot; -n &quot;$namespace&quot; --template=&quot;{{.status.podIP}}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># determine leader for partition three</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index=$(getIndexOfPodForPartitionInState &quot;3&quot; &quot;LEADER&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leaderTwo=$(getBroker &quot;$index&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leaderTwoIp=$(kubectl get pod &quot;$leaderTwo&quot; -n &quot;$namespace&quot; --template=&quot;{{.status.podIP}}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ &quot;$leaderTwo&quot; == &quot;$leader&quot; ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # determine leader for partition two</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  index=$(getIndexOfPodForPartitionInState &quot;2&quot; &quot;LEADER&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  leaderTwo=$(getBroker &quot;$index&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  leaderTwoIp=$(kubectl get pod &quot;$leaderTwo&quot; -n &quot;$namespace&quot; --template=&quot;{{.status.podIP}}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if [ &quot;$leaderTwo&quot; == &quot;$leader&quot; ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # We could try to kill the pod and hope that he is not able to become leader again,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # but there is a high chance that it is able to do so after restart. It can make our test fragile,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # especially if we want to connect again, which is the reason why we do nothing in that case.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># To print the topology in the journal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess kubectl exec &quot;$gateway&quot; -n &quot;$namespace&quot; -- zbctl status --insecure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># we put all into one function because we need to make sure that even after preemption the </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># dependency is installed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function disconnect() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> toChangedPod=&quot;$1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> targetIp=&quot;$2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # update to have access to ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl exec -n &quot;$namespace&quot; &quot;$toChangedPod&quot; -- apt update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl exec -n &quot;$namespace&quot; &quot;$toChangedPod&quot; -- apt install -y iproute2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> kubectl exec &quot;$toChangedPod&quot; -n &quot;$namespace&quot; -- ip route add unreachable &quot;$targetIp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect &quot;$leader&quot; &quot;$leaderTwoIp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess disconnect &quot;$leaderTwo&quot; &quot;$leaderIp&quot; </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="delete-network-partition">Delete network partition<a href="#delete-network-partition" class="hash-link" aria-label="Direct link to Delete network partition" title="Direct link to Delete network partition">​</a></h4>
<p>Looks similar to the disconnect script.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-different-deployment-versions">Deploy different deployment versions<a href="#deploy-different-deployment-versions" class="hash-link" aria-label="Direct link to Deploy different deployment versions" title="Direct link to Deploy different deployment versions">​</a></h5>
<p>This script is interesting. My first approach was to have one workflow model, where I replace an comment via <code>sed</code> before redeploying. Later I realized it is much easier to just have two versions of the same worfklow model in the repository and deploy them in an alternating manner. This reduced the dependecy of an extra tool (<code>sed</code>), which might not be available everywhere or work differently on different linux distributions.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -exuo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scriptPath=$( cd &quot;$(dirname &quot;${BASH_SOURCE[0]}&quot;)&quot; ; pwd -P )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source utils.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace=$(getNamespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod=$(getGateway)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bpmnPath=&quot;$scriptPath/../bpmn/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># we put both together in one function to retry both, because it might be that pod has been restarted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># then the model is not longer on the node, which cause endless retries of deployments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function deployModel() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubectl cp &quot;$bpmnPath&quot; &quot;$pod:/tmp/&quot; -n &quot;$namespace&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for i in {1..5}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # the models differ in one line, the share the same name and process id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # if we deploy them after another it will create two different deployment versions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # the deploy command only compares the last applied deployment - so we can do that in a loop to cause</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # multiple deployments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl exec &quot;$pod&quot; -n &quot;$namespace&quot; -- sh -c &quot;zbctl deploy /tmp/bpmn/multi-version/multiVersionModel.bpmn --insecure&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubectl exec &quot;$pod&quot; -n &quot;$namespace&quot; -- sh -c &quot;zbctl deploy /tmp/bpmn/multi-version/multiVersionModel_v2.bpmn --insecure&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess deployModel</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When running this script we deploy <code>10</code> new versions of the workflow <code>multiVersion</code>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="create-workflow-instance-of-latest-version-on-partition-x">Create workflow instance of latest version on partition X<a href="#create-workflow-instance-of-latest-version-on-partition-x" class="hash-link" aria-label="Direct link to Create workflow instance of latest version on partition X" title="Direct link to Create workflow instance of latest version on partition X">​</a></h4>
<p>The following script allows us to be sure that we can create a workflow instance on a specific partition with the given version of the <code>multiVersion</code> workflow.
This means we can verify that on all partitions the last deployment version is deployed/distributed.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -xo pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ -z &quot;$1&quot; ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo &quot;Please provide an required partition!&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if [ -z &quot;$2&quot; ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo &quot;Please provide an required deployment version!&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source utils.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace=$(getNamespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod=$(getGateway)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">requiredPartition=$1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">requiredDeploymentVersion=$2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">processId=&quot;multiVersion&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># we put all into one function because we need to make sure that even after preemption the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># dependency are installed, which is in this case is the deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function startInstancesOnPartition() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  partition=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  until [[ &quot;$partition&quot; -eq &quot;$requiredPartition&quot; ]]; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    workflowInstanceKey=$(kubectl exec &quot;$pod&quot; -n &quot;$namespace&quot; -- zbctl create instance &quot;$processId&quot; --version &quot;$requiredDeploymentVersion&quot; --insecure)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    workflowInstanceKey=$(echo &quot;$workflowInstanceKey&quot; | jq &#x27;.workflowInstanceKey&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    partition=$(( workflowInstanceKey &gt;&gt; 51 ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo &quot;Started workflow with key $workflowInstanceKey, corresponding partition $partition&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">retryUntilSuccess startInstancesOnPartition</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="outcome">Outcome<a href="#outcome" class="hash-link" aria-label="Direct link to Outcome" title="Direct link to Outcome">​</a></h3>
<p>After running this experiment we get the following output, which shows us that the experiment <strong>SUCCEEDED</strong>.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(chaostk) [zell camunda-cloud/ cluster: zeebe-cluster ns:zell-chaos]$ chaos run production-m/deployment-distribution/experiment.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:06 INFO] Validating the experiment&#x27;s syntax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:06 INFO] Experiment looks valid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:06 INFO] Running experiment: Zeebe deployment distribution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:06 INFO] Steady-state strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:06 INFO] Rollbacks strategy: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:06 INFO] Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:06 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:07 INFO] Probe: Should be able to create workflow instances on partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:10 INFO] Steady state hypothesis is met!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:10 INFO] Playing your experiment&#x27;s method now...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:10 INFO] Action: Create network partition between leaders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:26 INFO] Action: Deploy thousand different deployment versions.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:31 INFO] Action: Delete network partition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:43 INFO] Probe: Create workflow instance of latest version on partition one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:43 INFO] Probe: Create workflow instance of latest version on partition two</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:51 INFO] Probe: Create workflow instance of latest version on partition three</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:52 INFO] Steady state hypothesis: Zeebe is alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:52 INFO] Probe: All pods should be ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:52 INFO] Probe: Should be able to create workflow instances on partition 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:55 INFO] Steady state hypothesis is met!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:55 INFO] Let&#x27;s rollback...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:55 INFO] No declared rollbacks, let&#x27;s move on.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2021-02-23 14:15:55 INFO] Experiment ended with status: completed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="testbench">Testbench<a href="#testbench" class="hash-link" aria-label="Direct link to Testbench" title="Direct link to Testbench">​</a></h4>
<p>I executed the new experiment via zeebe testbench, to verify that this works with the <code>Production - M</code> cluster plan and it was successful <!-- -->💪</p>
<p><img loading="lazy" alt="operate" src="/zeebe-chaos/assets/images/operate-success-6cfd18e98918ee25187b83ca4b925442.png" width="1913" height="918" class="img_ev3q"></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;results&quot;:[&quot;production-m/deployment-distribution/experiment.json completed successfully&quot;,&quot;production-m/follower-restart/experiment.json completed successfully&quot;,&quot;production-m/follower-terminate/experiment.json completed successfully&quot;,&quot;production-m/leader-restart/experiment.json completed successfully&quot;,&quot;production-m/leader-terminate/experiment.json completed successfully&quot;,&quot;production-m/msg-correlation/experiment.json completed successfully&quot;,&quot;production-m/multiple-leader-restart/experiment.json completed successfully&quot;,&quot;production-m/snapshot-corruption/experiment.json completed successfully&quot;,&quot;production-m/stress-cpu-on-broker/experiment.json completed successfully&quot;,&quot;production-m/worker-restart/experiment.json completed successfully&quot;]}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zeebe-chaos/tags/tests">tests</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-days/blog/2021-02-23-automate-deployments-dist/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/zeebe-chaos/2021/03/09/cont-workflow-instance"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Fault-tolerant processing of process instances</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zeebe-chaos/2021/01/26/deployments"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Deployment Distribution</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#chaos-experiment" class="table-of-contents__link toc-highlight">Chaos Experiment</a><ul><li><a href="#expected" class="table-of-contents__link toc-highlight">Expected</a></li><li><a href="#experiment-definition" class="table-of-contents__link toc-highlight">Experiment Definition</a></li><li><a href="#outcome" class="table-of-contents__link toc-highlight">Outcome</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/zeebe" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forum.camunda.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/Camunda" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/zeebe-io/zeebe-chaos/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Zeebe Chaos. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>