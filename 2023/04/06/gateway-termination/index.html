<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.1">
<title data-rh="true">Gateway Termination | Zeebe Chaos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zeebe-io.github.io/zeebe-chaos/2023/04/06/gateway-termination"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Gateway Termination | Zeebe Chaos"><meta data-rh="true" name="description" content="In today&#x27;s chaos day, we wanted to experiment with the gateway and resiliency of workers."><meta data-rh="true" property="og:description" content="In today&#x27;s chaos day, we wanted to experiment with the gateway and resiliency of workers."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-04-06T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/zelldon"><meta data-rh="true" property="article:tag" content="availability,resiliency"><link data-rh="true" rel="icon" href="/zeebe-chaos/img/zeebe-logo.png"><link data-rh="true" rel="canonical" href="https://zeebe-io.github.io/zeebe-chaos/2023/04/06/gateway-termination"><link data-rh="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/2023/04/06/gateway-termination" hreflang="en"><link data-rh="true" rel="alternate" href="https://zeebe-io.github.io/zeebe-chaos/2023/04/06/gateway-termination" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://zeebe-io.github.io/zeebe-chaos/2023/04/06/gateway-termination","mainEntityOfPage":"https://zeebe-io.github.io/zeebe-chaos/2023/04/06/gateway-termination","url":"https://zeebe-io.github.io/zeebe-chaos/2023/04/06/gateway-termination","headline":"Gateway Termination","name":"Gateway Termination","description":"In today's chaos day, we wanted to experiment with the gateway and resiliency of workers.","datePublished":"2023-04-06T00:00:00.000Z","author":{"@type":"Person","name":"Christopher Kujawa","description":"Chaos Engineer @ Zeebe","url":"https://github.com/zelldon","image":"https://github.com/zelldon.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://zeebe-io.github.io/zeebe-chaos/","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/zeebe-chaos/rss.xml" title="Zeebe Chaos RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zeebe-chaos/atom.xml" title="Zeebe Chaos Atom Feed"><link rel="stylesheet" href="/zeebe-chaos/assets/css/styles.7f7b3e9a.css">
<script src="/zeebe-chaos/assets/js/runtime~main.8ae8d6c4.js" defer="defer"></script>
<script src="/zeebe-chaos/assets/js/main.4e7d4960.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zeebe-chaos/"><div class="navbar__logo"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zeebe-chaos/img/zeebe-logo.png" alt="Zeebe" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Zeebe Chaos</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zeebe-chaos/">Chaos Summaries</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/zeebe-io/zeebe-chaos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2024/08/16/Operate-load-handling">Operate load handling</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2024/07/25/Using-flow-control-to-handle-bottlenecked-exporting">Using flow control to handle bottleneck on exporting</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2024/07/25/Using-flow-control-to-handle-uncontrolled-process-loops">Using flow control to handle uncontrolled process loops</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2024/01/19/Job-Activation-Latency">Reducing the job activation delay</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/12/20/Broker-scaling-performance">Broker Scaling and Performance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/12/19/Dynamic-Scaling-with-Dataloss">Dynamic Scaling with Dataloss</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/12/18/Dynamically-scaling-brokers">Dynamically scaling brokers</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/12/06/Job-Push-resiliency">Job push resiliency</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/11/30/Job-push-overloading">Job push overloading</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/11/07/Hot-backups-impact-on-processing">Hot backups impact on processing</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/06/02/Using-Large-Multi-Instance">Using Large Multi-Instance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/05/19/Continuing-SST-Partitioning-toggle">Continuing SST Partitioning toggle</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/05/15/SST-Partitioning-toggle">SST Partitioning toggle</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/zeebe-chaos/2023/04/06/gateway-termination">Gateway Termination</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2023/02/23/Recursive-call-activity">Recursive call activity</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2022</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/08/31/Message-Correlation-after-Network-Partition">Message Correlation after Network Partition</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/08/02/deployment-distribution">Bring Deployment distribution experiment back</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/02/15/Standalone-Gateway-in-CCSaaS">Standalone Gateway in CCSaaS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/02/01/High-Snapshot-Frequency">High Snapshot Frequency</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2022/01/19/big-variables">Handling of Big Variables</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2021</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/11/24/Worker-count-should-not-impact-performance">Worker count should not impact performance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/11/11/Not-produce-duplicate-Keys">Not produce duplicate Keys</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/10/29/Throughput-on-big-state">Throughput on big state</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/10/05/recovery-time">Recovery (Fail Over) time</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/09/23/Old-Clients">Old-Clients</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/07/06/Slow-Network">Slow Network</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/06/08/Full-Disk">Full Disk Recovery</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/05/25/Reset-Clock">Time travel Experiment</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/04/29/Corrupted-Snapshot">Corrupted Snapshot Experiment Investigation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/04/03/bpmn-meets-chaos-engineering">BPMN meets Chaos Engineering</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/03/30/set-file-immutable">Set file immutable</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/03/23/camunda-cloud-network-partition">Camunda Cloud network partition</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/03/09/cont-workflow-instance">Fault-tolerant processing of process instances</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/02/23/automate-deployments-dist">Automating Deployment Distribution Chaos Experiment</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/01/26/deployments">Deployment Distribution</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/01/19/network-partition">Network partitions</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2021/01/07/disconnect-leader-and-follower">Disconnect Leader and one Follower</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2020</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/11/24/message-correlation-after-failover">Message Correlation after Failover</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/11/11/job-timeouts">Many Job Timeouts</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/11/03/investigate-failing-tests">Investigate failing Chaos Tests</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/20/non-graceful-shutdown">Non-graceful Shutdown Broker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/27/standalone-gw-memory">Gateway memory consumption</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/13/multiple-leader-changes">Multiple Leader Changes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/10/06/toxi-proxy">Play around with ToxiProxy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/08/20/experiment-with-camunda-cloud">Experiment with Camunda Cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/08/06/low-load">Experiment with Low Load</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/30/experiment-without-exporters">Experiment without Exporters</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/16/big-multi-instance">Big Multi Instance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/09/timer-and-huge-variables">Experiment with Timers and Huge Variables</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/07/02/extract-k8-resources">Extract K8 resources from namespace</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/25/gateway-network-partition">Gateway Network Partition</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/18/correlate-message-after-failover">Correlate Message after failover</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/11/high-cpu-gateway">High CPU load on Standalone Gateway</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zeebe-chaos/2020/06/04/first-chaos-day">First Chaos Day!</a></li></ul></div></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">Gateway Termination</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-04-06T00:00:00.000Z">April 6, 2023</time> Â· <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/zeebe-chaos/authors/zell"><img class="avatar__photo authorImage_XqGP" src="https://github.com/zelldon.png" alt="Christopher Kujawa"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/zeebe-chaos/authors/zell"><span class="authorName_yefp">Christopher Kujawa</span></a></div><small class="authorTitle_nd0D" title="Chaos Engineer @ Zeebe">Chaos Engineer @ Zeebe</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>In today&#x27;s chaos day, we wanted to experiment with the gateway and resiliency of workers.</p>
<p>We have seen in recent weeks some issues within our benchmarks when gateways have been restarted,
see <a href="https://github.com/camunda/camunda/issues/11975" target="_blank" rel="noopener noreferrer">zeebe#11975</a>.</p>
<p>We did a similar experiment <a href="/zeebe-chaos/2022/02/15/Standalone-Gateway-in-CCSaaS">in the past</a>,
today we want to focus on self-managed (<a href="https://helm.camunda.io/" target="_blank" rel="noopener noreferrer">benchmarks with our helm charts</a>).
Ideally, we can automate this as well soon.</p>
<p>Today <a href="https://github.com/npepinpe" target="_blank" rel="noopener noreferrer">Nicolas</a> joined me on the chaos day <!-- -->ðŸŽ‰</p>
<p><strong>TL;DR;</strong> We were able to show that the workers (clients) can reconnect after a gateway is shutdown <!-- -->âœ…<!-- -->
Furthermore, we have discovered a potential performance issue on lower load, which impacts process execution latency (<a href="https://github.com/camunda/camunda/issues/12311" target="_blank" rel="noopener noreferrer">zeebe#12311</a>).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="chaos-experiment">Chaos Experiment<a href="#chaos-experiment" class="hash-link" aria-label="Direct link to Chaos Experiment" title="Direct link to Chaos Experiment">â€‹</a></h2>
<p>We will use our <a href="https://github.com/zeebe-io/benchmark-helm" target="_blank" rel="noopener noreferrer">Zeebe benchmark helm charts</a> to set up the test cluster, and
our helper scripts <a href="https://github.com/camunda/camunda/tree/main/benchmarks/setup" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="setup">Setup:<a href="#setup" class="hash-link" aria-label="Direct link to Setup:" title="Direct link to Setup:">â€‹</a></h3>
<p>We will run with the default benchmark configuration, which means:</p>
<ul>
<li>three brokers</li>
<li>three partitions</li>
<li>replication count three</li>
<li>two gateways</li>
</ul>
<p>We will run the benchmark with a low load, 10 process instances per second created and completed. For that,
we deploy one starter and worker. This reduces the blast radius and allows us to observe more easily how the workers
behave when a gateway is restarted.</p>
<p>During the experiment, we will use our <a href="https://github.com/camunda/camunda/tree/main/monitor/grafana" target="_blank" rel="noopener noreferrer">grafana dashboard</a> to
observe to which gateway the worker will connect and which gateway we need to stop/restart.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LAST DEPLOYED: Thu Apr  6 10:21:27 2023</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE: zell-chaos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STATUS: deployed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REVISION: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NOTES:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Zeebe Benchmark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installed Zeebe cluster with:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 3 Brokers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 2 Gateways</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The benchmark is running with:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Starter replicas=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Worker replicas=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Publisher replicas=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Timer replicas=0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected">Expected<a href="#expected" class="hash-link" aria-label="Direct link to Expected" title="Direct link to Expected">â€‹</a></h3>
<p>When we terminate a gateway to which the worker has connected, <strong>we expect</strong> that the worker connects to the different
replica and starts completing jobs again.</p>
<p>The performance drop is expected to be not significant, or at least should recover fast.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="actual">Actual<a href="#actual" class="hash-link" aria-label="Direct link to Actual" title="Direct link to Actual">â€‹</a></h3>
<p>We will run the experiment in two ways, first via terminating the gateway (using <a href="https://github.com/zeebe-io/zeebe-chaos/releases/tag/zbchaos-v1.0.0" target="_blank" rel="noopener noreferrer">zbchaos</a>)
and later via scaling down the gateway deployment to one replica.</p>
<p>We want to verify whether this makes any difference, since terminating will cause Kubernetes to recreate immediately the pod.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="termination">Termination<a href="#termination" class="hash-link" aria-label="Direct link to Termination" title="Direct link to Termination">â€‹</a></h4>
<p>Before we start the experiment we check our current deployed state:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kgpo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                        READY   STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">camunda-platform-curator-28012860-zk72q     0/1     Completed   0          7m24s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-0                      1/1     Running     0          45m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-1                      1/1     Running     0          45m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-2                      1/1     Running     0          45m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leader-balancer-28012860-7cwmd              0/1     Completed   0          7m25s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">starter-cb69c447f-l2zbh                     1/1     Running     0          45m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker-cb7f7c469-qvqqv                      1/1     Running     0          45m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-0                          1/1     Running     0          45m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-1                          1/1     Running     0          45m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-2                          1/1     Running     0          45m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-7bbdf9fd58-vs28f   1/1     Running     0          45m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-7bbdf9fd58-xc6d9   1/1     Running     0          45m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Via our Grafana dashboard (and the gRPC metrics) we are able to track to which gateway the worker connects to:</p>
<p><img decoding="async" loading="lazy" alt="grpc" src="/zeebe-chaos/assets/images/grpc-13224311ab5e142b1d17c5bfeb3369d7.png" width="1545" height="840" class="img_ev3q"></p>
<p>It is <code>zell-chaos-zeebe-gateway-7bbdf9fd58-vs28f</code>.
Via zbchaos we can easily terminate the gateway (it will always take the first in the pod list).</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ zbchaos terminate gateway </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{1 LEADER -1  10  msg false 1 LEADER -1 2 LEADER -1 1680772377704 false false true false false 30 false -1 benchmark 30  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terminated zell-chaos-zeebe-gateway-7bbdf9fd58-vs28f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After terminating we can see that a new gateway pod has started.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kgpo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                        READY   STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">camunda-platform-curator-28012860-zk72q     0/1     Completed   0          13m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-0                      1/1     Running     0          52m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-1                      1/1     Running     0          52m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-2                      1/1     Running     0          52m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leader-balancer-28012860-7cwmd              0/1     Completed   0          13m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">starter-cb69c447f-l2zbh                     1/1     Running     0          52m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker-cb7f7c469-qvqqv                      1/1     Running     0          52m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-0                          1/1     Running     0          52m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-1                          1/1     Running     0          52m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-2                          1/1     Running     0          52m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-7bbdf9fd58-pkj48   1/1     Running     0          33s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-7bbdf9fd58-xc6d9   1/1     Running     0          52m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the metrics, we can see that due to the restart, the throughput slightly dropped, but recovered pretty fast. The worker
was able to connect to the different gateway. <!-- -->âœ…</p>
<p><img decoding="async" loading="lazy" alt="restart" src="/zeebe-chaos/assets/images/restart-fba3c5902c9b5523ca1f2fe9ba45def5.png" width="1848" height="883" class="img_ev3q"></p>
<blockquote>
<p><strong>Note</strong></p>
<p><em>In the panel <code>Pod Restarts</code> on the top right, we don&#x27;t see any restarts and that is something
we should always be aware of that the <em>metrics are just samples of data</em>. If a pod, like a gateway, restarts fast enough
and the metric collect interval is higher (per default we have ~30 s (?)) then you might not see a change.</em></p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="scale-down">Scale down<a href="#scale-down" class="hash-link" aria-label="Direct link to Scale down" title="Direct link to Scale down">â€‹</a></h4>
<p>As described earlier we wanted to verify whether it makes a difference if we scale down the replica instead of terminating/restarting
it, which causes restarting a new pod (which might get the same IP).</p>
<p>For scaling down Nicolas found this annotation: <code>controller.kubernetes.io/pod-deletion-cost</code></p>
<p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/#pod-deletion-cost" target="_blank" rel="noopener noreferrer">That annotation allows giving hints to the schedule which pod to turn-down, because another pod might have a higher cost
to be deleted (this is of course best-effort).</a></p>
<p>This means we edit one pod and gave the following annotation:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">controller.kubernetes.io/pod-deletion-cost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;-1&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We have similarly chosen the pod as we have seen above, based on the gRPC metrics.</p>
<p>Checking the running pods and editing the correct gateway:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[cqjawa 2023-04-06-gateway-termination/ cluster: zeebe-cluster ns:zell-chaos]$ kgpo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                        READY   STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">camunda-platform-curator-28012875-tntdv     0/1     Completed   0          6m26s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-0                      1/1     Running     0          59m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-1                      1/1     Running     0          59m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-2                      1/1     Running     0          59m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leader-balancer-28012875-sctwq              0/1     Completed   0          6m26s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">starter-cb69c447f-l2zbh                     1/1     Running     0          59m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker-cb7f7c469-qvqqv                      1/1     Running     0          59m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-0                          1/1     Running     0          59m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-1                          1/1     Running     0          59m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-2                          1/1     Running     0          59m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-7bbdf9fd58-pkj48   1/1     Running     0          8m29s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-7bbdf9fd58-xc6d9   1/1     Running     0          59m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When I did the following I was wondering why it didn&#x27;t scale down the deployment, one pod was recreated.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[cqjawa 2023-04-06-gateway-termination/ cluster: zeebe-cluster ns:zell-chaos]$ k scale replicaset zell-chaos-zeebe-gateway-7bbdf9fd58 --replicas=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: spec.template.spec.containers[0].env[16].name: duplicate name &quot;ZEEBE_LOG_LEVEL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/zell-chaos-zeebe-gateway-7bbdf9fd58 scaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[cqjawa 2023-04-06-gateway-termination/ cluster: zeebe-cluster ns:zell-chaos]$ kgpo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                        READY   STATUS            RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">camunda-platform-curator-28012875-tntdv     0/1     Completed         0          6m53s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-0                      1/1     Running           0          60m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-1                      1/1     Running           0          60m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-2                      1/1     Running           0          60m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leader-balancer-28012875-sctwq              0/1     Completed         0          6m53s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">starter-cb69c447f-l2zbh                     1/1     Running           0          60m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker-cb7f7c469-qvqqv                      1/1     Running           0          60m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-0                          1/1     Running           0          60m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-1                          1/1     Running           0          60m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-2                          1/1     Running           0          60m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-7bbdf9fd58-2v6gs   0/1     PodInitializing   0          7s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-7bbdf9fd58-pkj48   1/1     Running           0          8m56s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p><strong>Note:</strong></p>
<p>During the experiment I learned that when you have deployed a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener noreferrer">deployment</a>, you need to scale down the deployment, not the <a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/" target="_blank" rel="noopener noreferrer">ReplicaSet</a>.
Otherwise your Kubernetes deployment controller will recreate the ReplicaSet in the next reconcile loop, which means you
will have again the same replicas as defined in the deployment.</p>
</blockquote>
<p>So correct is to scale down the deployment (!), if you ever wonder.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[cqjawa 2023-04-06-gateway-termination/ cluster: zeebe-cluster ns:zell-chaos]$ k edit pod zell-chaos-zeebe-gateway-7bbdf9fd58-pkj48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/zell-chaos-zeebe-gateway-7bbdf9fd58-pkj48 edited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[cqjawa 2023-04-06-gateway-termination/ cluster: zeebe-cluster ns:zell-chaos]$ kgpo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                        READY   STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">camunda-platform-curator-28012875-tntdv     0/1     Completed   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-0                      1/1     Running     0          63m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-1                      1/1     Running     0          63m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-2                      1/1     Running     0          63m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leader-balancer-28012875-sctwq              0/1     Completed   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">starter-cb69c447f-l2zbh                     1/1     Running     0          63m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker-cb7f7c469-qvqqv                      1/1     Running     0          63m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-0                          1/1     Running     0          63m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-1                          1/1     Running     0          63m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-2                          1/1     Running     0          63m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-7bbdf9fd58-2v6gs   1/1     Running     0          3m40s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-7bbdf9fd58-pkj48   1/1     Running     0          12m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[cqjawa 2023-04-06-gateway-termination/ cluster: zeebe-cluster ns:zell-chaos]$ k scale deployment zell-chaos-zeebe-gateway --replicas=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: spec.template.spec.containers[0].env[16].name: duplicate name &quot;ZEEBE_LOG_LEVEL&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/zell-chaos-zeebe-gateway scaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[cqjawa 2023-04-06-gateway-termination/ cluster: zeebe-cluster ns:zell-chaos]$ kgpo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                        READY   STATUS      RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">camunda-platform-curator-28012875-tntdv     0/1     Completed   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-0                      1/1     Running     0          64m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-1                      1/1     Running     0          64m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elasticsearch-master-2                      1/1     Running     0          64m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leader-balancer-28012875-sctwq              0/1     Completed   0          10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">starter-cb69c447f-l2zbh                     1/1     Running     0          64m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker-cb7f7c469-qvqqv                      1/1     Running     0          64m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-0                          1/1     Running     0          64m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-1                          1/1     Running     0          64m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-2                          1/1     Running     0          64m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zell-chaos-zeebe-gateway-7bbdf9fd58-2v6gs   1/1     Running     0          4m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With that, we have only one gateway pod left, and all traffic goes to that gateway. Based on the metrics
we can see that the workers recovered everytime when we restarted/terminated or scaled down.</p>
<p><img decoding="async" loading="lazy" alt="activate" src="/zeebe-chaos/assets/images/activate-bd04e48187522a661ce740667de5dae7.png" width="917" height="414" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="general" src="/zeebe-chaos/assets/images/general-eccb10353f089541f74a3f82593a836d.png" width="1845" height="903" class="img_ev3q"></p>
<p>The experiment itself succeeded <!-- -->ðŸ’ª<!-- --> :white_check_marks:</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="found-bugs">Found Bugs<a href="#found-bugs" class="hash-link" aria-label="Direct link to Found Bugs" title="Direct link to Found Bugs">â€‹</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="zbchaos-print-verbose-logs">Zbchaos print verbose logs<a href="#zbchaos-print-verbose-logs" class="hash-link" aria-label="Direct link to Zbchaos print verbose logs" title="Direct link to Zbchaos print verbose logs">â€‹</a></h3>
<p>I realized that we still have <a href="https://github.com/zeebe-io/zeebe-chaos/issues/323" target="_blank" rel="noopener noreferrer">the issue with zbchaos</a> which is printing verbose logs:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ zbchaos terminate gateway </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{1 LEADER -1  10  msg false 1 LEADER -1 2 LEADER -1 1680772377704 false false true false false 30 false -1 benchmark 30  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Terminated zell-chaos-zeebe-gateway-7bbdf9fd58-vs28f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="segment-creation-impact">Segment creation impact<a href="#segment-creation-impact" class="hash-link" aria-label="Direct link to Segment creation impact" title="Direct link to Segment creation impact">â€‹</a></h3>
<p>During checking the metrics together with Nicolas, we realized that even on low load (10 PI/s) we have high spikes
in our processing execution latency.</p>
<p><img decoding="async" loading="lazy" alt="latency" src="/zeebe-chaos/assets/images/latency-9fda0fdb0283c3af3831aef3813997e6.png" width="1852" height="822" class="img_ev3q"></p>
<p>The spikes are going up to 1-1.5 seconds, while the avg is at 0.06s. This happens every 6 minutes.</p>
<p>We can see that the commit latency is as well at the same time high, which might be an issue because of the high IO.</p>
<p><img decoding="async" loading="lazy" alt="commit" src="/zeebe-chaos/assets/images/commit-541f81ca663ae80835fa6ef8357d94a7.png" width="1841" height="250" class="img_ev3q"></p>
<p>We first expected that to be related to snapshotting, but snapshots happen much more often.</p>
<p><img decoding="async" loading="lazy" alt="snapshot" src="/zeebe-chaos/assets/images/snapshot-count-1b18a9a53eeaf2d45ab3a6f109b5d981.png" width="923" height="276" class="img_ev3q"></p>
<p>Interestingly is that it seems to be related to our segment creation (again), even if we have
async segment creation in our journal built recently. We need to investigate this further within <a href="https://github.com/camunda/camunda/issues/12311" target="_blank" rel="noopener noreferrer">zeebe#12311</a>.</p>
<p><img decoding="async" loading="lazy" alt="segment" src="/zeebe-chaos/assets/images/segment-176d6a262460c14aa4dce22bdce1dab2.png" width="1850" height="402" class="img_ev3q"></p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zeebe-chaos/tags/availability">availability</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/zeebe-chaos/tags/resiliency">resiliency</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/zeebe-io/zeebe-chaos/blob/master/chaos-days/blog/2023-04-06-gateway-termination/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/zeebe-chaos/2023/05/15/SST-Partitioning-toggle"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">SST Partitioning toggle</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zeebe-chaos/2023/02/23/Recursive-call-activity"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Recursive call activity</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#chaos-experiment" class="table-of-contents__link toc-highlight">Chaos Experiment</a><ul><li><a href="#setup" class="table-of-contents__link toc-highlight">Setup:</a></li><li><a href="#expected" class="table-of-contents__link toc-highlight">Expected</a></li><li><a href="#actual" class="table-of-contents__link toc-highlight">Actual</a></li></ul></li><li><a href="#found-bugs" class="table-of-contents__link toc-highlight">Found Bugs</a><ul><li><a href="#zbchaos-print-verbose-logs" class="table-of-contents__link toc-highlight">Zbchaos print verbose logs</a></li><li><a href="#segment-creation-impact" class="table-of-contents__link toc-highlight">Segment creation impact</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/zeebe" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forum.camunda.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/Camunda" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/zeebe-io/zeebe-chaos/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2024 Zeebe Chaos. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>